# Google Classroom 年度更新自動化システム

Google Classroomのクラス管理作業を自動化するシステム（Phase 1実装済み）

## プロジェクト概要

このシステムは、Google Classroomの年度更新作業を自動化し、運用効率の向上とヒューマンエラーの削減を実現します。

### 実装状況

- ✅ **Phase 1: 旧年度クラスのアーカイブ** - 実装済み
- ✅ **Phase 2: 新年度クラスの作成** - 実装済み
- ✅ **Phase 3: トピックの作成** - 実装済み
- ✅ **Phase 4: 生徒・教員の一括登録** - 実装済み
- ✅ **ユーティリティ: クラスマスタ同期機能** - 実装済み
- ✅ **ユーティリティ: バックアップ・復元機能** - 実装済み

## プロジェクト構成

```
classroom-automation/
├── appsscript.json          # GASマニフェスト
├── src/
│   ├── main.gs              # メインエントリーポイント
│   ├── config.gs            # 設定管理モジュール
│   ├── phases/
│   │   └── phase1_archive.gs      # Phase 1: アーカイブ
│   ├── services/
│   │   └── sheet_service.gs       # スプレッドシート操作
│   └── utils/
│       ├── logger.gs              # ログ記録
│       └── error_handler.gs       # エラー処理
└── .clasp.json              # clasp設定
```

## セットアップ

### 1. スプレッドシート設定

対象スプレッドシート:
- スプレッドシートID: `1BJ-KBSQyJqbb9F8ixBWfXKLlPP4iALfsfuv9DJ-2or4`

#### 必須: システム設定シートに以下を追加

「システム設定 」シート（末尾にスペースあり）に以下の設定を追加してください:

| 設定項目名 | 設定値 | 備考 |
|-----------|--------|------|
| DRY_RUN_MODE | TRUE | テスト実行モード（実際のAPI呼び出しなし） |
| デバッグモード | FALSE | 詳細ログ出力の有効化 |

**重要**: 初回テストでは必ず `DRY_RUN_MODE = TRUE` に設定してください！

### 2. GASプロジェクト

GASプロジェクトID: `1lFH4ilIL4nczSNGaYikqvh3oQ1FO5J4moIAu367vxnhIzTKmgPxyhoSQ`

コードは既にデプロイ済みです。GASエディタで確認できます:
https://script.google.com/d/1lFH4ilIL4nczSNGaYikqvh3oQ1FO5J4moIAu367vxnhIzTKmgPxyhoSQ/edit

### 3. 初回認証

GASエディタで初めて実行する際、以下の権限が要求されます:

- Google Classroom へのアクセス
- Google Sheets へのアクセス
- 外部リクエストの送信

「権限を確認」→「許可」をクリックして承認してください。

## 使用方法

### GASエディタでの実行

1. GASエディタを開く: https://script.google.com/d/1lFH4ilIL4nczSNGaYikqvh3oQ1FO5J4moIAu367vxnhIzTKmgPxyhoSQ/edit

2. 以下の関数を実行できます:

#### テスト用関数

| 関数名 | 説明 |
|--------|------|
| `testSystemSettings()` | システム設定の確認 |
| `testSpreadsheetConnection()` | スプレッドシート接続テスト |
| `testClassMasterData()` | クラスマスタデータの表示 |
| `listAllMyCourses()` | 自分が教師のクラス一覧を表示 |

#### Phase 1実行関数

| 関数名 | 説明 |
|--------|------|
| `runDryRun()` | DRY-RUNモードで全フェーズ実行（推奨） |
| `testPhase1()` | Phase 1のみテスト実行 |
| `runPhase1Archive()` | Phase 1を実際に実行 |

#### Phase 2実行関数

| 関数名 | 説明 |
|--------|------|
| `testPhase2()` | Phase 2のみテスト実行 |
| `runPhase2CreateClasses()` | Phase 2を実際に実行 |

#### Phase 3実行関数

| 関数名 | 説明 |
|--------|------|
| `testPhase3()` | Phase 3のみテスト実行 |
| `runPhase3CreateTopics()` | Phase 3を実際に実行 |

#### Phase 4実行関数

| 関数名 | 説明 |
|--------|------|
| `testPhase4()` | Phase 4のみテスト実行 |
| `runPhase4RegisterMembers()` | Phase 4を実際に実行 |

#### ユーティリティ関数

| 関数名 | 説明 |
|--------|------|
| `syncClassMasterFromClassroom()` | Classroomの現在の状態をクラスマスタに同期 |
| `getCourseIdFromEnrollmentCode(code)` | 招待コードからクラスIDを取得 |
| `backupClassMaster()` | クラスマスタのバックアップを作成 |
| `restoreClassMaster(backupSheetName)` | 指定されたバックアップから復元 |
| `restoreFromLatestBackup()` | 最新のバックアップから復元 |
| `listBackups()` | バックアップ一覧を表示 |
| `cleanupOldBackups(keepCount)` | 古いバックアップを削除（デフォルト: 5件保持） |

### 実行手順

#### 1. 動作確認（推奨）

```
1. GASエディタで「testSystemSettings()」を実行
   → DRY_RUN_MODE が TRUE であることを確認

2. 「testSpreadsheetConnection()」を実行
   → すべてのシートが正しく認識されているか確認

3. 「testClassMasterData()」を実行
   → アーカイブ対象のクラスが表示されることを確認
```

#### 2. DRY-RUN実行

```
1. 「runDryRun()」を実行
   → ログに「[DRY-RUN]」が表示され、実際のAPI呼び出しは行われません

2. 「登録処理ログ」シートを確認
   → 処理結果が「成功（DRY-RUN）」として記録されていることを確認
```

#### 3. 本番実行（慎重に！）

```
1. スプレッドシートの「システム設定 」シートで
   DRY_RUN_MODE を FALSE に変更

2. 「testPhase1()」または「runPhase1Archive()」を実行
   → 実際にClassroom APIが呼び出され、クラスがアーカイブされます

3. 「登録処理ログ」シートと「エラー未処理リスト」シートを確認
```

### Phase 1の動作

Phase 1は以下の処理を実行します:

1. クラスマスタから状態が "Archived" のクラスを抽出
2. 各クラスに対して:
   - クラス名に年度プレフィックスを付与（例: "2025_数学"）
   - Classroom APIでクラスをアーカイブ
3. 処理結果を「登録処理ログ」に記録
4. エラーが発生した場合は「エラー未処理リスト」に記録

### Phase 2の動作

Phase 2は以下の処理を実行します:

1. クラスマスタから状態が "New" **かつ** 科目有効性が "TRUE" **かつ** クラスID（B列）が空のクラスを抽出
2. 各クラスに対して:
   - Classroom APIでクラスを作成（オーナー: **スクリプト実行者**）
   - 作成されたクラスIDをクラスマスタのB列に記録
   - クラス状態を "Active" に更新
3. 処理結果を「登録処理ログ」に記録
4. エラーが発生した場合は「エラー未処理リスト」に記録

**重要**:
- 科目有効性が FALSE のクラスはスキップされます
- **既にクラスIDが存在する場合は重複作成を防ぐためスキップされます**
- クラスのオーナーはスクリプトを実行したアカウントになります
- 必要に応じて、作成後に手動で担当教員にオーナーを移譲してください

### Phase 3の動作

Phase 3は以下の処理を実行します:

1. クラスマスタから状態が "Active" **かつ** トピック作成（H列）が "TRUE" のクラスを抽出
2. 各クラスに対して:
   - 既存トピックを取得して重複チェック
   - 未作成のトピックのみを作成（重複防止）
   - トピックを逆順で作成（表示順を固定）
3. 処理結果を「登録処理ログ」に記録
4. エラーが発生した場合は「エラー未処理リスト」に記録

**作成されるトピック（5つ）**:
1. お知らせ
2. 授業資料
3. 課題
4. テスト
5. その他

**重要**:
- トピック作成フラグ（H列）が FALSE のクラスはスキップされます
- **既に全トピックが存在する場合はスキップされます**
- 一部トピックのみ存在する場合は、未作成のトピックのみ作成されます
- トピックは逆順（その他→テスト→課題→授業資料→お知らせ）で作成され、正しい表示順になります

### Phase 4の動作

Phase 4は以下の処理を実行します:

1. クラスマスタから状態が \"Active\" **かつ** 科目有効性が \"TRUE\" のクラスを抽出
2. 履修登録マスタ・教員マスタ・アカウントマッピングを読み込み
3. マトリクス形式のデータを縦持ち形式に変換:
   - 履修登録マスタ（○マーク）→ 生徒履修リスト
   - 教員マスタ（○マーク）→ 教員担当リスト
4. クラスごとにグループ化して招待送信:
   - 生徒に招待メールを送信（Invitations.create API - role: STUDENT）
   - 教員に招待メールを送信（Invitations.create API - role: TEACHER）
   - **生徒・教員が招待を承諾すると、クラスに参加完了**
5. 処理結果を「登録処理ログ」に記録
6. エラーが発生した場合は「エラー未処理リスト」に記録

**履修登録マスタの構造** (A:氏名 | B:学籍番号 | **C:有効フラグ** | D以降:科目):
- C列「有効」が TRUE の生徒のみ処理（転入生追加時に既登録者をスキップ可能）

**重要**:
- **招待方式のため、生徒・教員が招待メールの「承諾」ボタンをクリックする必要があります**
- 科目有効性が FALSE のクラスはスキップされます
- 履修登録マスタのC列「有効」が FALSE/空の生徒はスキップされます
- DRY_RUNモードでもバリデーションを実行し、エラーを事前検出します
- **生徒のバリデーション**（学籍番号でアカウントマッピングと照合）:
  - アカウントマッピング存在チェック
  - **氏名整合性チェック**（履修登録マスタ ↔ アカウントマッピング）
  - アカウント有効性チェック（isActive=FALSE はスキップ）
  - メールアドレス存在チェック
  - **ドメインチェック**（@shs.kyoto-art.ac.jp）
- **教員のバリデーション**（教員マスタのメールアドレスを直接使用）:
  - メールアドレス存在チェック
  - **ドメインチェック**（@office.kyoto-art.ac.jp）
- API Rate Limit対策として、各API呼び出し間に待機時間を挿入します

**アカウントマッピングの列構成**:
- A列: 内部ID（学籍番号）
- B列: 氏名
- C列: Googleメールアドレス
- D列: GoogleユーザーID
- E列: 所属クラス/学年
- F列: アカウント有効性（TRUE/FALSE）
- G列: 最終同期日時

### クラスマスタ同期機能の使い方

Classroomの現在の状態をスプレッドシートに反映できます。

#### 実行方法

```javascript
syncClassMasterFromClassroom()
```

#### 動作内容

1. Google Classroomから自分が教師として参加している全クラスを取得
2. クラスID（B列）で既存データと照合
3. 既存クラスは更新、新規クラスは追加
4. クラス状態（Active/Archived）を自動判定

#### 更新される列

- A列（科目名）: Classroomの最新名に更新
- B列（クラスID）: 変更なし
- E列（クラス状態）: Classroomの状態を反映（ACTIVE → Active, ARCHIVED → Archived）

#### 保持される列

- C列（履修登録マスタの列名）: 既存値を保持（手動入力したデータが失われない）
- D列（科目有効性）: 既存値を保持
- F列（担当教員名）: 既存値を保持
- G列（最終オーナーメールアドレス）: 既存値を保持

#### 科目有効性について

D列「科目有効性」は以下で使用されます:
- **Phase 2（クラス作成）**: `TRUE` の科目のみクラスを作成
- **Phase 4（履修登録）**: `TRUE` の科目のみ履修登録処理を実行
- **用途例**: 休講科目や廃止科目を `FALSE` に設定

## ローカル開発

### clasp使用

```bash
# プロジェクトのクローン
clasp clone 1lFH4ilIL4nczSNGaYikqvh3oQ1FO5J4moIAu367vxnhIzTKmgPxyhoSQ

# コードの編集後、GASにプッシュ
clasp push -f

# ログの確認
clasp logs
```

## トラブルシューティング

### DRY_RUN_MODE設定が見つからない

**エラー**: `設定値取得エラー: DRY_RUN_MODE`

**解決策**: スプレッドシートの「システム設定 」シート（末尾にスペースあり）に以下を追加:
- A列: `DRY_RUN_MODE`
- B列: `TRUE`

### シートが見つからない

**エラー**: `シート「XXX」が見つかりません`

**解決策**: 要件定義書に従って、必要なシートを作成してください。必須シート:
- クラス（科目）マスタ
- 履修登録マスタ
- 教員マスタ
- アカウントマッピング
- 登録処理ログ
- エラー未処理リスト
- システム設定 （末尾にスペースあり）
- 一時作業スペース

### 権限エラー

**エラー**: `権限不足`

**解決策**: GASエディタで関数を実行し、権限の許可を求められたら承認してください。

## 全フェーズ完了

すべてのフェーズの実装が完了しました:

1. ✅ Phase 1: 旧年度クラスのアーカイブ
2. ✅ Phase 2: 新年度クラスの作成
3. ✅ Phase 3: トピックの作成
4. ✅ Phase 4: 生徒・教員の一括登録

**実行前の確認事項**:
- 必ず `DRY_RUN_MODE = TRUE` でテスト実行してください
- 各フェーズの処理結果を「登録処理ログ」シートで確認してください
- エラーが発生した場合は「エラー未処理リスト」シートを確認してください

## 参考資料

- [要件定義書](./Google_Classroom_年度更新自動化システム_要件定義書_v2.md)
- [Google Classroom API](https://developers.google.com/classroom)
- [clasp](https://github.com/google/clasp)
