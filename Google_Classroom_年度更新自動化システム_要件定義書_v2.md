# Google Classroom 年度更新自動化システム 要件定義書

**文書番号**: DX-REQ-2025-001 (Rev. 2.0)  
**作成日**: 2025年12月26日  
**改訂日**: 2025年12月26日  
**作成者**: ICT担当  
**対象年度**: 2026年度から運用開始予定  
**開発環境**: Claude Code + clasp (Google Apps Script CLI)

---

## 📋 目次

1. [エグゼクティブサマリー](#1-エグゼクティブサマリー)
2. [プロジェクト概要](#2-プロジェクト概要)
3. [システムアーキテクチャ](#3-システムアーキテクチャ)
4. [データ仕様（スプレッドシート設計）](#4-データ仕様スプレッドシート設計)
5. [実行フェーズ別機能要件](#5-実行フェーズ別機能要件)
6. [技術要件・実装仕様](#6-技術要件実装仕様)
7. [運用フロー](#7-運用フロー)
8. [エラーハンドリング仕様](#8-エラーハンドリング仕様)
9. [開発ガイドライン（Claude Code向け）](#9-開発ガイドラインclaude-code向け)
10. [テスト仕様](#10-テスト仕様)
11. [承認事項・スケジュール](#11-承認事項スケジュール)

---

## 1. エグゼクティブサマリー

### 1.1 概要
本システムは、Google Classroomの年度更新作業（旧クラスのアーカイブ、新クラスの作成、トピック設定、メンバー登録）を自動化し、運用効率の向上とヒューマンエラーの削減を実現します。

### 1.2 改善効果

| 項目 | 現状 | 改善後 | 効果 |
|------|------|--------|------|
| データ管理 | 複数箇所に情報が分散 | 一元化・正規化 | データ不整合リスクの解消 |
| オーナー管理 | 手動でクラス作成時に設定 | 管理者初期作成 + 手動交代 | 大量クラス作成の効率化 |
| 作業時間 | 3時間20分程度 | 90%削減 | 運用工数の大幅削減 |

### 1.3 技術スタック

- **実行環境**: Google Apps Script (GAS)
- **開発ツール**: Claude Code + clasp
- **データソース**: Google Sheets（9シート構成）
- **外部API**: Google Classroom API

---

## 2. プロジェクト概要

### 2.1 目的・背景
Google Classroomのクラス管理作業を自動化し、以下を実現する：
- 登録漏れ・誤登録のリスク排除
- トピック構成の統一化
- アーカイブ忘れによる混乱防止
- 年度更新作業の工数削減

### 2.2 現状の課題と解決策

| 課題 | 解決策（システム機能） |
|------|----------------------|
| 登録漏れ・誤登録のリスク | 履修マスタとアカウントマッピングに基づいた自動登録（Phase 4） |
| トピック構成の不統一 | 固定トピックパターンの一括作成（Phase 3） |
| アーカイブ忘れによる混乱 | クラス状態フラグとアーカイブ機能によるライフサイクル管理（Phase 1） |

---

## 3. システムアーキテクチャ

### 3.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                     Google Sheets                                │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐             │
│  │クラス（科目）  │ │履修登録マスタ │ │ 教員マスタ   │             │
│  │  マスタ      │ │              │ │              │             │
│  └──────────────┘ └──────────────┘ └──────────────┘             │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐             │
│  │アカウント    │ │科目-教員     │ │ システム設定 │             │
│  │マッピング    │ │マッピング    │ │              │             │
│  └──────────────┘ └──────────────┘ └──────────────┘             │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐             │
│  │登録処理ログ  │ │エラー未処理  │ │一時作業スペース│             │
│  │              │ │リスト        │ │              │             │
│  └──────────────┘ └──────────────┘ └──────────────┘             │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Google Apps Script (GAS)                        │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐               │
│  │ Phase 1 │ │ Phase 2 │ │ Phase 3 │ │ Phase 4 │               │
│  │アーカイブ│ │クラス作成│ │トピック │ │メンバー │               │
│  │         │ │         │ │作成     │ │登録     │               │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘               │
│                            │                                     │
│  ┌─────────────────────────┴────────────────────────────────┐   │
│  │                     共通モジュール                         │   │
│  │  - Config: 設定管理                                       │   │
│  │  - Logger: ログ記録                                       │   │
│  │  - ErrorHandler: エラー処理                               │   │
│  │  - ApiClient: Classroom API呼び出し                       │   │
│  │  - DataTransformer: マトリクス→縦持ち変換                 │   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                 Google Classroom API                             │
│  - classroom.courses (クラス作成・更新・アーカイブ)              │
│  - classroom.topics (トピック作成・管理)                         │
│  - classroom.rosters (生徒・教員の登録・削除)                    │
│  - classroom.profile.emails (ユーザーメール取得)                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 処理フロー概要

```
[開始]
   │
   ▼
[システム設定読み込み] ── DRY_RUN_MODE確認
   │
   ▼
┌──────────────────────────────────────────────┐
│ Phase 1: 旧年度クラスのアーカイブ             │
│ - クラス状態が"Archived"のものを対象          │
│ - クラス名に年度プレフィックス付与            │
│ - Classroom APIでアーカイブ実行               │
└──────────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────────┐
│ Phase 2: 新年度クラスの作成                   │
│ - クラス状態が"New"のものを対象               │
│ - 管理者アカウントをオーナーとして作成        │
│ - 作成後、クラス状態を"Active"に更新          │
└──────────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────────┐
│ Phase 3: トピックの作成                       │
│ - クラス状態が"Active"のものを対象            │
│ - 固定トピックパターンを逆順で作成            │
└──────────────────────────────────────────────┘
   │
   ▼
┌──────────────────────────────────────────────┐
│ Phase 4: 生徒・教員の一括登録                 │
│ - 履修登録マスタ→生徒登録                    │
│ - 教員マスタ→教員登録                        │
│ - バッチ処理でAPI効率化                       │
└──────────────────────────────────────────────┘
   │
   ▼
[終了] ── ログ・エラーリスト更新
```

---

## 4. データ仕様（スプレッドシート設計）

### 4.1 シート一覧

| No | シート名 | 用途 | 読み書き |
|----|----------|------|----------|
| 1 | クラス（科目）マスタ | クラスの基本情報、ライフサイクル管理 | 読み取り・書き込み |
| 2 | 履修登録マスタ | 生徒の履修科目（○/空欄マトリクス） | 読み取りのみ |
| 3 | 教員マスタ | 教員の担当科目（○/空欄マトリクス）とアカウント情報 | 読み取りのみ |
| 4 | アカウントマッピング | 生徒の学籍番号とGoogleアカウント紐付け | 読み取りのみ |
| 5 | 登録処理ログ | 全操作履歴とAPI実行結果 | 書き込みのみ |
| 6 | エラー未処理リスト | 手動対応が必要な処理一覧 | 書き込みのみ |
| 7 | システム設定 | 環境設定値（管理者ID、DRY_RUN等） | 読み取りのみ |
| 8 | ~~一時作業スペース~~ | （実装では未使用：データはメモリ上で直接変換） | ~~読み書き~~ |

---

### 4.2 シート詳細設計

#### 4.2.1 クラス（科目）マスタ

**シート名**: `クラス（科目）マスタ`

| 列 | 列名 | データ型 | 必須 | 説明 | 値の例 |
|----|------|----------|------|------|--------|
| A | 科目名 | String | ○ | 科目の表示名 | `国語` |
| B | クラスID (Classroom API用) | String | ○ | Classroom APIで使用するクラス識別子 | `GCA_JAP_001` |
| C | 履修登録マスタの列名 | String | ○ | 履修登録マスタで対応する列名 | `国語` |
| D | 科目有効性 (TRUE/FALSE) | Boolean | ○ | 科目が有効かどうか | `TRUE` / `FALSE` |
| E | クラス状態 | String | ○ | ライフサイクル状態 | `New` / `Active` / `Archived` |
| F | 担当教員名 | String | - | 担当教員の表示名 | `山田 先生` |
| G | 最終オーナーメールアドレス | String | - | オーナー交代先のメールアドレス | `yamada@school.jp` |
| H | トピック作成 (TRUE/FALSE) | Boolean | - | Phase 3でトピックを作成するかどうか | `TRUE` / `FALSE` |

**クラス状態の定義**:
- `New`: 新規作成待ち（Phase 2の対象）
- `Active`: 運用中（Phase 3, 4の対象）
- `Archived`: アーカイブ対象（Phase 1の対象）

**科目有効性について**:
- **D列「科目有効性」**: `TRUE`の科目のみPhase 2（クラス作成）、Phase 4（履修登録）の処理対象となる。休講科目や廃止科目を`FALSE`に設定することで、処理から除外できる。

**トピック作成について**:
- **H列「トピック作成」**: `TRUE`のクラスのみPhase 3でトピックが作成される。一部のクラスでトピック作成を不要とする場合に`FALSE`を設定する。

**サンプルデータ**:
```
| 科目名 | クラスID        | 履修登録マスタの列名 | 科目有効性 | クラス状態 | 担当教員名 | 最終オーナーメールアドレス | トピック作成 |
|--------|-----------------|---------------------|-----------|-----------|-----------|------------------------|-----------|
| 国語   | GCA_JAP_001     | 国語                | TRUE      | Active    |           |                        | TRUE      |
| 数学   | GCA_MAT_002     | 数学                | TRUE      | New       |           |                        | TRUE      |
| 英語   | GCA_ENG_003     | 英語                | FALSE     | Active    |           |                        | FALSE     |
| 理科   | GCA_SCI_004     | 理科                | TRUE      | Active    |           |                        | TRUE      |
| 社会   | GCA_SOC_005     | 社会                | TRUE      | Active    |           |                        | TRUE      |
| 情報   | GCA_INF_006     | 情報                | TRUE      | New       |           |                        | FALSE     |
```

---

#### 4.2.2 履修登録マスタ

**シート名**: `履修登録マスタ`

| 列 | 列名 | データ型 | 必須 | 説明 | 値の例 |
|----|------|----------|------|------|--------|
| A | 氏名 | String | ○ | 生徒の氏名 | `田中 太郎` |
| B | 学籍番号 | String | ○ | 生徒の一意識別子（アカウントマッピングのキー） | `S2025001` |
| C | 有効 | Boolean | ○ | 処理対象かどうか（転入生管理用） | `TRUE` / `FALSE` |
| D〜 | [科目名] | String | - | 履修している場合は「○」、していない場合は空欄 | `○` または空欄 |

**重要**:
- **C列「有効」フラグ**: 転入生追加時など、既登録者を再処理せず新規生徒のみ招待可能にするためのフラグ。`FALSE`の生徒はPhase 4でスキップされる。
- D列以降の列名は「クラス（科目）マスタ」の「履修登録マスタの列名」と一致させること
- 横持ち（マトリクス）形式のため、GASで縦持ちに変換して処理する

**サンプルデータ**:
```
| 氏名     | 学籍番号  | 有効 | 国語 | 数学 | 英語 | 理科 | 社会 |
|----------|----------|------|------|------|------|------|------|
| 田中 太郎 | S2025001 | TRUE | ○    | ○    |      | ○    | ○    |
| 佐藤 花子 | S2025002 | TRUE |      | ○    | ○    |      | ○    |
| 鈴木 健太 | S2025003 | TRUE | ○    |      | ○    | ○    |      |
| 高橋 美咲 | S2025004 | TRUE | ○    | ○    | ○    |      | ○    |
| 小林 大地 | S2025005 | TRUE |      | ○    |      | ○    | ○    |
| 山田 結衣 | S2025006 | TRUE | ○    | ○    | ○    | ○    | ○    |
```

---

#### 4.2.3 教員マスタ

**シート名**: `教員マスタ`

| 列 | 列名 | データ型 | 必須 | 説明 | 値の例 |
|----|------|----------|------|------|--------|
| A | 教員氏名 | String | ○ | 教員の氏名 | `山田 先生` |
| B | 教員メールアドレス (Googleアカウント) | String | ○ | Google Workspaceのメールアドレス | `yamada@school.jp` |
| C | 教員アカウント有効性 (TRUE/FALSE) | Boolean | ○ | アカウントが有効かどうか | `TRUE` / `FALSE` |
| D〜 | [科目名] | String | - | 担当している場合は「○」、していない場合は空欄 | `○` または空欄 |

**重要**: 
- D列以降の列名は「クラス（科目）マスタ」の「科目名」と一致させること
- 「教員アカウント有効性」が`FALSE`の教員はスキップされる

**サンプルデータ**:
```
| 教員氏名  | 教員メールアドレス        | 教員アカウント有効性 | 国語 | 数学 | 英語 | 理科 | 社会 | 情報 |
|----------|--------------------------|---------------------|------|------|------|------|------|------|
| 山田 先生 | yamada@school.jp         | TRUE                | ○    | ○    |      | ○    |      | ○    |
| 佐藤 先生 | sato@school.jp           | TRUE                |      | ○    | ○    |      | ○    | ○    |
| 田中 先生 | tanaka@school.jp         | TRUE                | ○    |      | ○    | ○    |      | ○    |
| 鈴木 先生 | suzuki@school.jp         | TRUE                |      | ○    |      | ○    | ○    |      |
| 高橋 先生 | takahashi@school.jp      | FALSE               | ○    | ○    | ○    |      | ○    | ○    |
```

---

#### 4.2.4 アカウントマッピング

**シート名**: `アカウントマッピング`

| 列 | 列名 | データ型 | 必須 | 説明 | 値の例 |
|----|------|----------|------|------|--------|
| A | 内部ID (学籍番号など) | String | ○ | 履修登録マスタの学籍番号と紐付け | `S2025001` |
| B | Googleメールアドレス | String | ○ | Google Workspaceのメールアドレス | `taro.t@school.jp` |
| C | GoogleユーザーID (Classroom API用) | String | - | Classroom APIで使用するユーザーID | `CUSR10001` |
| D | 所属クラス/学年 | String | - | 参考情報 | `1年A組` |
| E | アカウント有効性 (TRUE/FALSE) | Boolean | ○ | アカウントが有効かどうか | `TRUE` / `FALSE` |
| F | 最終同期日時 | DateTime | - | 最後にデータ同期した日時 | `2025-12-26 18:40:00` |

**重要**: 
- 「アカウント有効性」が`FALSE`の生徒はスキップされ、エラーリストに記録される

**サンプルデータ**:
```
| 内部ID    | Googleメールアドレス   | GoogleユーザーID | 所属クラス/学年 | アカウント有効性 | 最終同期日時         |
|----------|----------------------|-----------------|----------------|-----------------|---------------------|
| S2025001 | taro.t@school.jp     | CUSR10001       | 1年A組          | TRUE            | 2025-12-26 18:40:00 |
| S2025002 | hanako.s@school.jp   | CUSR10002       | 1年B組          | TRUE            | 2025-12-26 18:40:00 |
| S2025003 | kenta.s@school.jp    | CUSR10003       | 1年A組          | TRUE            | 2025-12-26 18:40:00 |
| S2025004 | misaki.t@school.jp   | CUSR10004       | 1年C組          | FALSE           | 2025-12-20 09:00:00 |
| S2025005 | daichi.k@school.jp   | CUSR10005       | 1年B組          | TRUE            | 2025-12-26 18:40:00 |
| S2025006 | yui.y@school.jp      | CUSR10006       | 1年C組          | TRUE            | 2025-12-26 18:40:00 |
```

---

#### 4.2.5 登録処理ログ

**シート名**: `登録処理ログ`

| 列 | 列名 | データ型 | 必須 | 説明 | 値の例 |
|----|------|----------|------|------|--------|
| A | 処理日時 | DateTime | ○ | 処理が実行された日時 | `2025-12-26 18:00:00` |
| B | 生徒名 | String | - | 処理対象の生徒名（生徒登録時） | `田中 太郎` |
| C | 学籍番号 | String | - | 処理対象の学籍番号（生徒登録時） | `S2025001` |
| D | 科目名 | String | ○ | 処理対象の科目名 | `国語` |
| E | Classroom ID/招待コード | String | ○ | クラスIDまたは招待コード | `GCA_JAP_001` |
| F | 処理結果 | String | ○ | 成功/失敗 | `成功` / `失敗` |
| G | APIレスポンス/エラーメッセージ | String | - | APIの応答内容 | `200 OK` / `Invalid Email Format` |
| H | 実行者/システム | String | ○ | 処理を実行した主体 | `Auto Reg Bot` |
| I | 招待方法 | String | - | 招待の方法（メール/リンク等） | `email` / `link` |
| J | 権限交代状況 | String | - | オーナー交代の状況追跡用 | `完了` / `未完了` |

**サンプルデータ**:
```
| 処理日時             | 生徒名   | 学籍番号  | 科目名 | Classroom ID | 処理結果 | APIレスポンス          | 実行者        | 招待方法 | 権限交代状況 |
|---------------------|---------|----------|--------|--------------|---------|----------------------|--------------|---------|------------|
| 2025-12-26 18:00:00 | 田中 太郎 | S2025001 | 国語   | GCA_JAP_001  | 成功    | 200 OK               | Auto Reg Bot |         |            |
| 2025-12-26 18:01:00 | 佐藤 花子 | S2025002 | 数学   | ma002tokyo   | 失敗    | Invalid Email Format | Auto Reg Bot |         |            |
| 2025-12-26 18:02:00 | 鈴木 健太 | S2025003 | 英語   | en003tokyo   | 成功    | 200 OK               | Auto Reg Bot |         |            |
```

---

#### 4.2.6 エラー未処理リスト

**シート名**: `エラー未処理リスト`

| 列 | 列名 | データ型 | 必須 | 説明 | 値の例 |
|----|------|----------|------|------|--------|
| A | 発生日時 | DateTime | ○ | エラーが発生した日時 | `2025-12-26 18:01:00` |
| B | 生徒名 | String | - | エラー対象の生徒名 | `佐藤 花子` |
| C | 学籍番号 | String | - | エラー対象の学籍番号 | `S2025002` |
| D | 科目名 | String | ○ | エラー対象の科目名 | `数学` |
| E | エラーコード | String | ○ | エラーの種類を示すコード | `ERR_005` |
| F | エラー詳細（原因） | String | ○ | エラーの詳細説明 | `メールアドレスの形式が不正です` |
| G | 対応状況 | String | ○ | 未対応/対応中/保留/対応済 | `未対応` |
| H | 対応担当者 | String | - | 対応を担当する人 | `鈴木` |
| I | 備考 | String | - | 補足情報 | `要再実行` |
| J | エラー発生回数 | Number | - | 同一エラーの発生回数（集計用） | `3` |

**エラーコード一覧**:
| コード | 説明 |
|--------|------|
| ERR_005 | メールアドレスの形式が不正 |
| ERR_007 | 登録上限数超過 |
| ERR_120 | Google Workspaceアカウントなし |
| WARN_101 | 招待リンク期限切れの可能性 |
| WARN_200 | 履修マスタに対象科目なし |

**サンプルデータ**:
```
| 発生日時             | 生徒名   | 学籍番号  | 科目名  | エラーコード | エラー詳細                      | 対応状況 | 対応担当者 | 備考     | エラー発生回数 |
|---------------------|---------|----------|--------|-------------|-------------------------------|---------|-----------|---------|--------------|
| 2025-12-26 18:01:00 | 佐藤 花子 | S2025002 | 数学   | ERR_005     | メールアドレスの形式が不正です     | 未対応   |           |         |              |
| 2025-12-26 18:03:00 | 高橋 美咲 | S2025004 | 理科   | WARN_101    | 招待リンク期限切れの可能性        | 保留    |           | 要再実行 |              |
| 2025-12-26 18:05:00 | 小林 大地 | S2025005 | 社会   | ERR_120     | Google Workspaceアカウントなし  | 未対応   |           |         |              |
| 2025-12-26 18:07:00 | 山田 結衣 | S2025006 | 英語   | ERR_007     | 登録上限数超過                  | 未対応   |           |         |              |
| 2025-12-26 18:08:00 | 田中 太郎 | S2025001 | 選択X  | WARN_200    | 履修マスタに対象科目なし         | 対応済   | 鈴木       | データ修正 |              |
```

---

#### 4.2.7 システム設定

**シート名**: `システム設定 ` （※末尾にスペースあり）

| 列 | 列名 | データ型 | 必須 | 説明 | 値の例 |
|----|------|----------|------|------|--------|
| A | 設定項目名 | String | ○ | 設定の名称 | `管理者アカウントID` |
| B | 設定値 | String | ○ | 設定の値 | `admin.it@school.jp` |
| C | 備考 | String | - | 設定の説明 | `クラス作成時のオーナーアカウントID` |
| D | 最終更新日時 | DateTime | - | 設定が最後に更新された日時 | `2025-12-26 18:30:00` |
| E | 実行スケジュール (TRUE/FALSE) | Boolean | - | スケジュール実行の有効/無効 | `TRUE` / `FALSE` |
| F | 処理対象年度 | Number | - | 処理対象の年度 | `2026` |

**必須の設定項目**:

| 設定項目名 | 説明 | 必須設定値の例 |
|-----------|------|---------------|
| 管理者アカウントID | クラス作成時の初期オーナーとなるGoogleアカウント | `admin.it@school.jp` |
| 管理者メールアドレス | エラー通知先のメールアドレス | `admin.it@school.jp` |
| DRY_RUN_MODE | テスト実行モード（TRUEでAPIを実際に呼び出さない） | `TRUE` / `FALSE` |
| デバッグモード | 詳細ログ出力の有効化 | `TRUE` / `FALSE` |
| タイムゾーン | 実行時間の基準 | `Asia/Tokyo` |
| ログ保存期間 (日数) | ログを保持する日数 | `90` |
| 処理対象マスタ名 | 読み込むデータのシート名 | `履修登録マスタ` |

**注意**: 現在のスプレッドシートには`DRY_RUN_MODE`が存在しないため、**追加が必要**。

**サンプルデータ**:
```
| 設定項目名             | 設定値              | 備考                          | 最終更新日時         | 実行スケジュール | 処理対象年度 |
|-----------------------|--------------------|-----------------------------|---------------------|-----------------|-------------|
| Classroom APIキー      | [KeyValue]         | 認証用シークレットキー           | 2025-12-26 18:30:00 | TRUE            | 2025        |
| 管理者メールアドレス    | admin.it@school.jp | エラー通知先メールアドレス        | 2025-11-01 10:00:00 | TRUE            | 2026        |
| ログ保存期間 (日数)     | 90                 | 90日経過したログは自動削除       | 2025-11-01 10:00:00 | TRUE            | 2025        |
| 処理対象マスタ名        | 履修登録マスタ       | 読み込むデータのシート名         | 2025-12-26 18:30:00 | FALSE           | 2025        |
| デバッグモード         | FALSE              | 詳細ログ出力の有効化            | 2025-10-05 15:22:00 | TRUE            | 2024        |
| タイムゾーン           | Asia/Tokyo         | 実行時間の基準                 | 2025-10-05 15:22:00 | FALSE           | 2026        |
| 管理者アカウントID      | [AdminID]          | クラス作成時のオーナーアカウントID |                     | FALSE           |             |
| DRY_RUN_MODE          | TRUE               | テスト実行モード（要追加）       |                     |                 |             |
```

---

#### 4.2.8 ~~一時作業スペース~~（実装では未使用）

**シート名**: `一時作業スペース`

**実装での取り扱い**:
- **このシートは実装では使用されていません**
- データ変換（マトリクス→縦持ち）はメモリ上で直接実行され、スプレッドシートへの書き込みを省略することで処理速度を向上
- 以下の仕様は、将来的にデータ変換の中間結果をスプレッドシート上で確認したい場合の参考として記載

**（参考）設計時の列定義**:

| 列 | 列名 | データ型 | 必須 | 説明 | 値の例 |
|----|------|----------|------|------|--------|
| A | 学籍番号 | String | ○ | 履修登録マスタの学籍番号 | `S2025001` |
| B | Googleメールアドレス | String | ○ | アカウントマッピングから取得 | `taro.t@school.jp` |
| C | 科目名 | String | ○ | 履修登録マスタの科目名 | `国語` |
| D | Classroom ID | String | ○ | クラス（科目）マスタのクラスID | `GCA_JAP_001` |
| E | 登録要否 (TRUE/FALSE) | Boolean | ○ | 登録処理を行うかどうか | `TRUE` / `FALSE` |
| F | 処理実行フラグ | String | ○ | 実行状態 | `未実行` / `実行中` / `実行済` / `エラー` / `スキップ` / `保留` |
| G | 最終処理結果 (成功/エラー詳細) | String | - | 処理結果の詳細 | `成功` / `ERR_005: メールアドレス無効` |
| H | タイムスタンプ | DateTime | - | 処理日時 | `2025-12-26 18:45:00` |

---

## 5. 実行フェーズ別機能要件

### 5.1 Phase 1: 旧年度クラスのアーカイブ

#### 5.1.1 概要
旧年度のクラスをアーカイブし、混乱を防止する。

#### 5.1.2 対象データ
- **読み取り**: クラス（科目）マスタ（クラス状態が`Archived`のレコード）
- **書き込み**: 登録処理ログ

#### 5.1.3 処理フロー

```
[開始]
   │
   ▼
[クラス（科目）マスタ読み込み]
   │
   ▼
[クラス状態 = "Archived" のレコード抽出]
   │
   ▼
[各クラスに対してループ処理]
   │
   ├─▶ [クラス名に年度プレフィックス付与]
   │   例: "数学I-A組" → "2025_数学I-A組"
   │
   ├─▶ [DRY_RUN_MODE確認]
   │   │
   │   ├─ TRUE: ログのみ記録（APIコールなし）
   │   │
   │   └─ FALSE: Classroom API実行
   │            - courses.update() でクラス名変更
   │            - courses.update() でcourseStateを"ARCHIVED"に変更
   │
   └─▶ [登録処理ログに記録]
       │
       ▼
[終了]
```

#### 5.1.4 API仕様

```javascript
// クラス名変更
Classroom.Courses.update(
  { name: "2025_" + originalName },
  courseId
);

// アーカイブ
Classroom.Courses.update(
  { courseState: "ARCHIVED" },
  courseId
);
```

---

### 5.2 Phase 2: 新年度クラスの作成

#### 5.2.1 概要
新年度のクラスを作成し、管理者を初期オーナーとして設定する。

#### 5.2.2 対象データ
- **読み取り**: クラス（科目）マスタ（クラス状態が`New`のレコード）、システム設定
- **書き込み**: クラス（科目）マスタ（クラスID、クラス状態の更新）、登録処理ログ

#### 5.2.3 処理フロー

```
[開始]
   │
   ▼
[システム設定から管理者アカウントID取得]
   │
   ▼
[クラス（科目）マスタ読み込み]
   │
   ▼
[クラス状態 = "New" かつ 科目有効性 = TRUE のレコード抽出]
   │
   ▼
[各クラスに対してループ処理]
   │
   ├─▶ [クラス情報設定]
   │   - name: 科目名
   │   - section: セクション情報（任意）
   │   - ownerId: 管理者アカウントID
   │
   ├─▶ [DRY_RUN_MODE確認]
   │   │
   │   ├─ TRUE: ログのみ記録（APIコールなし）
   │   │
   │   └─ FALSE: Classroom API実行
   │            - courses.create() でクラス作成
   │            - 返却されたcourseIdを保存
   │
   ├─▶ [クラス（科目）マスタ更新]
   │   - クラスID列に実際のCourseIdを記録
   │   - クラス状態を"Active"に更新
   │
   └─▶ [登録処理ログに記録]
       │
       ▼
[終了]
```

#### 5.2.4 API仕様

```javascript
// クラス作成
const course = Classroom.Courses.create({
  name: subjectName,
  section: sectionName,
  ownerId: adminAccountId,
  courseState: "ACTIVE"
});

// 返却値
// course.id: Classroom APIで使用するクラスID
```

---

### 5.3 Phase 3: トピックの作成

#### 5.3.1 概要
全クラスに共通のトピック構造を作成する。

#### 5.3.2 対象データ
- **読み取り**: クラス（科目）マスタ（クラス状態が`Active`のレコード）
- **書き込み**: 登録処理ログ

#### 5.3.3 固定トピックパターン
以下のトピックを**逆順で作成**することで、表示順を固定する。

| 順序 | トピック名 | 説明 |
|------|-----------|------|
| 1 | お知らせ | 連絡事項 |
| 2 | 授業資料 | 教材・資料 |
| 3 | 課題 | 提出物 |
| 4 | テスト | 試験関連 |
| 5 | その他 | 分類外の投稿 |

#### 5.3.4 処理フロー

```
[開始]
   │
   ▼
[クラス（科目）マスタ読み込み]
   │
   ▼
[クラス状態 = "Active" のレコード抽出]
   │
   ▼
[各クラスに対してループ処理]
   │
   ├─▶ [既存トピック確認]
   │   │
   │   └─ 既にトピックが存在する場合はスキップ
   │
   ├─▶ [トピックを逆順で作成]
   │   - "その他" → "テスト" → "課題" → "授業資料" → "お知らせ"
   │
   ├─▶ [DRY_RUN_MODE確認]
   │   │
   │   ├─ TRUE: ログのみ記録
   │   │
   │   └─ FALSE: Classroom API実行
   │
   └─▶ [登録処理ログに記録]
       │
       ▼
[終了]
```

#### 5.3.5 API仕様

```javascript
// トピック作成（逆順で実行）
const topics = ["その他", "テスト", "課題", "授業資料", "お知らせ"];
topics.forEach(topicName => {
  Classroom.Courses.Topics.create(
    { name: topicName },
    courseId
  );
});
```

---

### 5.4 Phase 4: 生徒・教員の一括登録（最重要）

#### 5.4.1 概要
履修登録マスタと教員マスタに基づき、生徒と教員をクラスに一括登録する。

#### 5.4.2 対象データ
- **読み取り**: 
  - 履修登録マスタ（生徒の履修情報）
  - 教員マスタ（教員の担当情報・Googleアカウント）
  - アカウントマッピング（生徒のGoogleアカウント）
  - クラス（科目）マスタ（クラスIDの参照）
- **書き込み**: 
  - 一時作業スペース（処理状態の管理）
  - 登録処理ログ
  - エラー未処理リスト

#### 5.4.3 処理フロー

```
[開始]
   │
   ▼
[マスタデータ読み込み]
   │
   ├─▶ [履修登録マスタ]
   ├─▶ [教員マスタ]
   ├─▶ [アカウントマッピング]
   └─▶ [クラス（科目）マスタ]
   │
   ▼
[マトリクス→縦持ち変換]
   │
   ├─▶ [生徒: 履修登録マスタの「○」セルを抽出]
   │   → (学籍番号, 科目名) のペアリスト生成
   │
   └─▶ [教員: 教員マスタの「○」セルを抽出]
       → (教員メール, 科目名) のペアリスト生成
   │
   ▼
[アカウント検証]
   │
   ├─▶ [生徒: アカウントマッピングからGoogleメール取得]
   │   - 有効性チェック（アカウント有効性 = TRUE）
   │   - 無効な場合はエラーリストに追加してスキップ
   │
   └─▶ [教員: 教員マスタから直接メール取得]
       - 有効性チェック（教員アカウント有効性 = TRUE）
       - 無効な場合はエラーリストに追加してスキップ
   │
   ▼
[一時作業スペースにデータ投入]
   │
   ▼
[クラスごとにバッチ処理]
   │
   ▼
[各クラスに対してループ処理]
   │
   ├─▶ [対象メンバーリスト作成]
   │   - 生徒: STUDENT役割
   │   - 教員: TEACHER役割（共同教師）
   │
   ├─▶ [DRY_RUN_MODE確認]
   │   │
   │   ├─ TRUE: ログのみ記録
   │   │
   │   └─ FALSE: Classroom API実行
   │            - invitations.create() で招待
   │            - または students.create() / teachers.create() で直接登録
   │
   ├─▶ [一時作業スペース更新]
   │   - 処理実行フラグ、最終処理結果を更新
   │
   └─▶ [ログ・エラーリスト更新]
       │
       ▼
[終了]
```

#### 5.4.4 マトリクス→縦持ち変換ロジック

```javascript
/**
 * 履修登録マスタ（横持ち）から縦持ちリストを生成
 * 
 * 入力例:
 * | 氏名     | 学籍番号  | 国語 | 数学 | 英語 |
 * |----------|----------|------|------|------|
 * | 田中 太郎 | S2025001 | ○    | ○    |      |
 * | 佐藤 花子 | S2025002 |      | ○    | ○    |
 * 
 * 出力例:
 * [
 *   { studentId: "S2025001", subject: "国語" },
 *   { studentId: "S2025001", subject: "数学" },
 *   { studentId: "S2025002", subject: "数学" },
 *   { studentId: "S2025002", subject: "英語" }
 * ]
 */
function convertMatrixToVertical(sheetData, headerRow, dataStartRow, keyColumn, dataStartColumn) {
  const result = [];
  const headers = sheetData[headerRow]; // 科目名の配列
  
  for (let row = dataStartRow; row < sheetData.length; row++) {
    const rowData = sheetData[row];
    const keyValue = rowData[keyColumn]; // 学籍番号
    
    for (let col = dataStartColumn; col < rowData.length; col++) {
      if (rowData[col] === "○") {
        result.push({
          studentId: keyValue,
          subject: headers[col]
        });
      }
    }
  }
  
  return result;
}
```

#### 5.4.5 API仕様

**実装での選択**: **Invitations API を使用**

```javascript
// 生徒への招待送信（実装で使用）
Classroom.Invitations.create({
  courseId: courseId,
  userId: studentEmail,
  role: "STUDENT"
});

// 教員への招待送信（実装で使用）
Classroom.Invitations.create({
  courseId: courseId,
  userId: teacherEmail,
  role: "TEACHER"
});
```

**選択理由**:
- `Students.create()` / `Teachers.create()` は組織のセキュリティポリシーにより制限されている場合がある
- `Invitations.create()` は手動招待と同じフローで、より緩い権限で動作
- 招待受信者が承諾することでクラスに参加（セキュリティ面で優位）

**（参考）直接追加APIの仕様**:
```javascript
// 生徒の直接追加（実装では未使用）
Classroom.Courses.Students.create(
  { userId: studentEmail },
  courseId
);

// 教員の直接追加（実装では未使用）
Classroom.Courses.Teachers.create(
  { userId: teacherEmail },
  courseId
);
```

#### 5.4.6 オーナー管理について

**重要**: オーナー交代は手動で行うことを前提とする。

1. クラス作成時: システム設定の「管理者アカウントID」がオーナーとなる
2. 教員登録時: 教員マスタで該当科目に「○」がついている教員を「共同教師（TEACHER）」として登録
3. オーナー交代: 運用担当者が手動でClassroom UIから交代を実行

---

### 5.5 ユーティリティ機能: バックアップ・復元

#### 5.5.1 概要
クラスマスタシートの誤操作に備え、バックアップと復元機能を提供する。

#### 5.5.2 機能一覧

| 機能 | 関数名 | 説明 |
|------|--------|------|
| バックアップ作成 | `backupClassMaster()` | クラスマスタシートを複製してタイムスタンプ付きバックアップを作成 |
| 復元 | `restoreClassMaster(backupSheetName)` | 指定されたバックアップからクラスマスタを復元 |
| 最新バックアップから復元 | `restoreFromLatestBackup()` | 最新のバックアップから自動復元 |
| バックアップ一覧表示 | `listBackups()` | 全バックアップシートを新しい順に一覧表示 |
| 古いバックアップの削除 | `cleanupOldBackups(keepCount)` | 指定件数を超える古いバックアップを自動削除 |

#### 5.5.3 バックアップシートの命名規則

```
バックアップ_{タイムスタンプ}

例: バックアップ_20251228_143052
```

- タイムスタンプ形式: `yyyyMMdd_HHmmss`（日本時間）
- バックアップシートはスプレッドシートの最後に配置

#### 5.5.4 復元時の動作

1. 現在のクラスマスタシートの内容をクリア
2. 指定されたバックアップシートからデータをコピー
3. フォーマット（書式）も含めて復元
4. トースト通知で復元完了を表示

#### 5.5.5 使用シーン

- **Phase 2実行前**: クラスマスタの現在の状態をバックアップ
- **手動編集前**: 大規模な変更を行う前にバックアップ
- **誤操作後**: 最新のバックアップから復元
- **定期メンテナンス**: 古いバックアップの削除（推奨: 5件保持）

---

## 6. 技術要件・実装仕様

### 6.1 推奨実装プラットフォーム

| 選択肢 | 推奨度 | 理由 |
|--------|--------|------|
| Google Apps Script (GAS) | ✅ 推奨 | Google Sheetsとの統合が容易、追加インフラ不要、認証が簡素化され運用が容易 |

### 6.2 Google Classroom APIと権限設定

全フェーズの実行には、適切なOAuth 2.0認証と以下のスコープが必要。

| スコープ | 用途 |
|----------|------|
| `https://www.googleapis.com/auth/classroom.courses` | クラスの作成・更新（アーカイブ） |
| `https://www.googleapis.com/auth/classroom.topics` | トピックの作成・管理 |
| `https://www.googleapis.com/auth/classroom.rosters` | 生徒・教員の登録・削除 |
| `https://www.googleapis.com/auth/classroom.profile.emails` | ユーザーのメールアドレス取得 |
| `https://www.googleapis.com/auth/spreadsheets` | スプレッドシートの読み書き |

### 6.3 API Rate Limitと対策

| 制限値 | 対策（GASロジック） |
|--------|-------------------|
| 書き込み制限 | Phase 4でバッチ処理を適用し、リクエスト数を削減 |
| 制限超過 | 指数バックオフリトライ：エラー時に待機時間を延ばして再試行（例: 1秒 → 2秒 → 4秒） |
| 連続リクエスト | リクエスト間に200ms〜500msの`Utilities.sleep()`待機を挿入 |

### 6.4 GASプロジェクト構成

```
classroom-automation/
├── appsscript.json          # GASマニフェスト
├── src/
│   ├── main.gs              # メインエントリーポイント
│   ├── config.gs            # 設定管理モジュール
│   ├── phases/
│   │   ├── phase1_archive.gs      # Phase 1: アーカイブ
│   │   ├── phase2_create.gs       # Phase 2: クラス作成
│   │   ├── phase3_topics.gs       # Phase 3: トピック作成
│   │   └── phase4_members.gs      # Phase 4: メンバー登録
│   ├── services/
│   │   ├── classroom_service.gs   # Classroom API呼び出し
│   │   ├── sheet_service.gs       # スプレッドシート操作
│   │   └── data_transformer.gs    # マトリクス変換
│   ├── utils/
│   │   ├── logger.gs              # ログ記録
│   │   ├── error_handler.gs       # エラー処理
│   │   └── rate_limiter.gs        # API制限対策
│   └── constants.gs              # 定数定義
├── tests/
│   └── test_runner.gs            # テスト実行
└── .clasp.json                   # clasp設定
```

### 6.5 appsscript.json 設定

```json
{
  "timeZone": "Asia/Tokyo",
  "dependencies": {
    "enabledAdvancedServices": [
      {
        "userSymbol": "Classroom",
        "serviceId": "classroom",
        "version": "v1"
      }
    ]
  },
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/classroom.courses",
    "https://www.googleapis.com/auth/classroom.topics",
    "https://www.googleapis.com/auth/classroom.rosters",
    "https://www.googleapis.com/auth/classroom.profile.emails",
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/script.external_request"
  ]
}
```

---

## 7. 運用フロー

### 7.1 年度更新時の運用フロー

| フェーズ | 実行内容 | 担当者/システム | 備考 |
|---------|---------|----------------|------|
| 準備 (実行前) | 1. マスタ更新: 履修、教員、アカウントマッピングを最新化 | 運用担当者 | |
| DRY-RUN | `DRY_RUN_MODE`を`TRUE`に設定し、全フェーズを実行。登録処理ログを確認し、問題ないことを確認 | 運用担当者 | APIはコールされない |
| Phase 1-3実行 | `DRY_RUN_MODE`を`FALSE`に戻し、クラス作成・トピック設定を実行 | システム | |
| Phase 4実行 | 生徒・教員の一括登録を実行 | システム | |
| 手動確認 (重要) | オーナー交代: 管理者から科目マスタに記載の最終オーナーへ権限を手動で移譲 | 運用担当者 | |
| 確認 (実行後) | エラー/未処理リストを確認し、残ったエラー（無効アカウントなど）を手動で対応 | 運用担当者 | |

### 7.2 GAS実行方法

```javascript
// 全フェーズ実行
function runAllPhases() {
  runPhase1Archive();
  runPhase2CreateClasses();
  runPhase3CreateTopics();
  runPhase4RegisterMembers();
}

// 個別実行
function runPhase1Archive() { /* ... */ }
function runPhase2CreateClasses() { /* ... */ }
function runPhase3CreateTopics() { /* ... */ }
function runPhase4RegisterMembers() { /* ... */ }

// DRY-RUN実行
function runDryRun() {
  setDryRunMode(true);
  runAllPhases();
}
```

---

## 8. エラーハンドリング仕様

### 8.1 エラーコード体系

| コード | カテゴリ | 説明 | 対応方法 |
|--------|---------|------|---------|
| ERR_001 | 認証 | APIトークン期限切れ | 再認証を実行 |
| ERR_002 | 認証 | 権限不足 | スコープ設定を確認 |
| ERR_003 | データ | 必須フィールド欠損 | マスタデータを修正 |
| ERR_004 | データ | 不正なデータ形式 | マスタデータを修正 |
| ERR_005 | データ | メールアドレス形式不正 | メールアドレスを修正 |
| ERR_006 | API | Rate Limit超過 | 待機後に再試行 |
| ERR_007 | API | クラス登録上限超過 | 手動対応が必要 |
| ERR_120 | アカウント | Google Workspaceアカウントなし | アカウント作成が必要 |
| WARN_101 | 警告 | 招待リンク期限切れ | 再招待を実行 |
| WARN_200 | 警告 | 履修マスタに対象科目なし | マスタデータを確認 |

### 8.2 リトライ戦略

```javascript
function executeWithRetry(apiFunction, maxRetries = 3) {
  let retryCount = 0;
  let lastError = null;
  
  while (retryCount < maxRetries) {
    try {
      return apiFunction();
    } catch (error) {
      lastError = error;
      retryCount++;
      
      if (isRateLimitError(error)) {
        // 指数バックオフ
        const waitTime = Math.pow(2, retryCount) * 1000;
        Utilities.sleep(waitTime);
      } else if (!isRetryableError(error)) {
        throw error;
      }
    }
  }
  
  throw lastError;
}
```

---

## 9. 開発ガイドライン（Claude Code向け）

### 9.1 開発環境セットアップ

```bash
# claspのインストール
npm install -g @google/clasp

# Googleアカウントでログイン
clasp login

# プロジェクトのクローン（既存のGASプロジェクトがある場合）
clasp clone <SCRIPT_ID>

# または新規作成
clasp create --type standalone --title "Classroom Automation"
```

### 9.2 開発フロー

1. **ローカルで開発**: `.gs`ファイルを編集
2. **デプロイ**: `clasp push`でGASにアップロード
3. **テスト**: GASエディタまたはローカルでテスト実行
4. **ログ確認**: `clasp logs`でログを確認

### 9.3 コーディング規約

```javascript
/**
 * モジュールの説明
 * @module ModuleName
 */

/**
 * 関数の説明
 * @param {string} param1 - パラメータ1の説明
 * @param {number} param2 - パラメータ2の説明
 * @returns {Object} 戻り値の説明
 * @throws {Error} エラーの説明
 */
function functionName(param1, param2) {
  // 実装
}

// 定数は大文字スネークケース
const MAX_RETRY_COUNT = 3;

// 変数・関数はキャメルケース
let currentIndex = 0;
function processData() { }

// クラス名はパスカルケース
class DataProcessor { }
```

### 9.4 スプレッドシートIDの設定

```javascript
// config.gs
const CONFIG = {
  SPREADSHEET_ID: "YOUR_SPREADSHEET_ID_HERE", // ← ここにスプレッドシートIDを設定
  
  SHEET_NAMES: {
    CLASS_MASTER: "クラス（科目）マスタ",
    ENROLLMENT_MASTER: "履修登録マスタ",
    TEACHER_MASTER: "教員マスタ",
    ACCOUNT_MAPPING: "アカウントマッピング",
    PROCESS_LOG: "登録処理ログ",
    ERROR_LIST: "エラー未処理リスト",
    SYSTEM_SETTINGS: "システム設定 ", // 末尾にスペースあり
    TEMP_WORKSPACE: "一時作業スペース"
  }
};
```

### 9.5 主要な実装パターン

#### シート読み込み

```javascript
function getSheetData(sheetName) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const sheet = ss.getSheetByName(sheetName);
  return sheet.getDataRange().getValues();
}
```

#### シート書き込み

```javascript
function appendToSheet(sheetName, rowData) {
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  const sheet = ss.getSheetByName(sheetName);
  sheet.appendRow(rowData);
}
```

#### 設定値取得

```javascript
function getSystemSetting(settingName) {
  const data = getSheetData(CONFIG.SHEET_NAMES.SYSTEM_SETTINGS);
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === settingName) {
      return data[i][1];
    }
  }
  return null;
}
```

---

## 10. テスト仕様

### 10.1 テスト環境

- **テスト用スプレッドシート**: 本番とは別のスプレッドシートを使用
- **テスト用Classroom**: 専用のテストクラスを使用

### 10.2 テストケース

| No | テスト項目 | 入力 | 期待結果 |
|----|-----------|------|---------|
| 1 | DRY_RUN実行 | DRY_RUN_MODE=TRUE | APIコールなし、ログのみ記録 |
| 2 | Phase 1正常系 | クラス状態=Archived | クラスがアーカイブされる |
| 3 | Phase 2正常系 | クラス状態=New | クラスが作成され、状態がActiveに更新 |
| 4 | Phase 3正常系 | クラス状態=Active | トピックが作成される |
| 5 | Phase 4正常系 | 履修登録あり | 生徒・教員が登録される |
| 6 | 無効アカウント | アカウント有効性=FALSE | スキップされ、エラーリストに追加 |
| 7 | Rate Limit | 大量リクエスト | リトライ後に成功 |

---

## 11. 承認事項・スケジュール

### 11.1 DX部門への確認事項

1. 本要件定義の内容（特に手動でのオーナー交代を前提とした点）について問題ないか
2. テスト環境の提供（専用テストクラスの作成）
3. Google Cloud Projectの作成とOAuth 2.0設定のサポート

### 11.2 想定スケジュール

| 期間 | 内容 |
|------|------|
| 現在 | 要件定義完了 |
| 2026年1月 | 実装方針決定、開発開始 |
| 2026年2月 | 単体テスト・結合テスト |
| 2026年3月上旬 | 本番環境テスト |
| 2026年3月下旬 | 年度更新で本格運用開始 🚀 |

---

## 📝 改訂履歴

| バージョン | 日付 | 改訂内容 | 改訂者 |
|-----------|------|---------|--------|
| 1.0 | 2025-12-26 | 初版作成 | ICT担当 |
| 2.0 | 2025-12-26 | スプレッドシート実構造との整合性確認・詳細化、Claude Code開発向けガイドライン追加 | Claude |
| 2.1 | 2025-12-26 | 科目-教員マッピングシートを削除（教員マスタで代替可能、オーナー交代は手動のため不要）、8シート構成に変更 | Claude |

---

**以上**
