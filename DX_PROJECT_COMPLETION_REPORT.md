# Google Classroom 年度更新自動化システム - プロジェクト完了報告書

**報告日**: 2025年12月27日
**報告者**: 野中孝利 (t-nonaka@office.kyoto-art.ac.jp)
**報告先**: DX部門

---

## 📋 プロジェクト概要

### 目的
Google Classroomの年度更新作業（クラスのアーカイブ、新規作成、トピック設定、生徒・教員の一括登録）を自動化し、運用効率の向上とヒューマンエラーの削減を実現する。

### 開発期間
- 開始日: 2025年12月26日
- 完了日: 2025年12月27日
- 開発期間: 2日間

---

## ✅ 実装完了機能

### Phase 1: 旧年度クラスのアーカイブ ✅

**機能**:
- クラスマスタから状態が「Archived」のクラスを自動抽出
- クラス名に年度プレフィックスを付与（例: 「数学」→「2025_数学」）
- Classroom APIでクラスをアーカイブ

**効果**:
- 手動操作: 1クラスあたり約1分 × 50クラス = **50分**
- 自動化後: 一括実行で**約3分**（DRY_RUNテスト含む）
- **時間削減: 約47分（94%削減）**

---

### Phase 2: 新年度クラスの作成 ✅

**機能**:
- クラスマスタから状態が「New」かつ科目有効性が「TRUE」のクラスを抽出
- スクリプト実行者をオーナーとして新規クラスを自動作成
- 作成後、クラスIDをクラスマスタに記録し、状態を「Active」に更新
- 重複作成防止機能

**効果**:
- 手動操作: 1クラスあたり約2分 × 50クラス = **100分**
- 自動化後: 一括実行で**約5分**
- **時間削減: 約95分（95%削減）**

---

### Phase 3: トピックの作成 ✅

**機能**:
- クラスマスタから状態が「Active」かつトピック作成フラグが「TRUE」のクラスを抽出
- 5つの標準トピック（「お知らせ」「授業資料」「課題」「テスト」「その他」）を自動作成
- 重複チェック機能（既存トピックがある場合は未作成のみ追加）

**効果**:
- 手動操作: 1クラスあたり約3分 × 50クラス = **150分**
- 自動化後: 一括実行で**約3分**
- **時間削減: 約147分（98%削減）**

---

### Phase 4: 生徒・教員の一括登録 ✅

**機能**:
- クラスマスタから状態が「Active」かつ科目有効性が「TRUE」のクラスを抽出
- 履修登録マスタ・教員マスタ・アカウントマッピングから対象者を自動抽出
- 招待メール送信方式（Invitations API）で生徒・教員を一括登録
- 包括的なバリデーション（アカウント存在、有効性、ドメインチェック）

**効果**:
- 手動操作: 1人あたり約30秒 × 500人 = **250分（4時間超）**
- 自動化後: 一括実行で**約20分**
- **時間削減: 約230分（92%削減）**

**技術的特徴**:
- 招待承諾が必要（生徒・教員がメールで承諾）
- クラス単位の最適化により実行時間を大幅短縮（10倍高速化）
- API Rate Limit対策済み

---

### ユーティリティ: クラスマスタ同期機能 ✅

**機能**:
- Google Classroomの現在の状態をスプレッドシートに反映
- クラスID（B列）で既存データと照合し、新規クラスは追加、既存クラスは更新
- クラス状態（Active/Archived）を自動判定

**効果**:
- Classroom UIとスプレッドシートの手動同期作業を自動化
- データの不整合を防止

---

## 📊 全体の効果

### 作業時間の削減

| フェーズ | 手動作業時間 | 自動化後 | 削減時間 | 削減率 |
|---------|-------------|----------|---------|--------|
| Phase 1 | 50分 | 3分 | 47分 | 94% |
| Phase 2 | 100分 | 5分 | 95分 | 95% |
| Phase 3 | 150分 | 3分 | 147分 | 98% |
| Phase 4 | 250分 | 20分 | 230分 | 92% |
| **合計** | **550分（9.2時間）** | **31分** | **519分（8.7時間）** | **94%** |

### その他の効果
- ✅ ヒューマンエラーの削減（手動入力ミス、設定漏れの防止）
- ✅ データ整合性の向上（スプレッドシートとClassroomの自動同期）
- ✅ トレーサビリティの確保（全処理をログに記録）
- ✅ 再現性の向上（同じ手順で毎年実行可能）

---

## 🛠️ 技術スタック

### 開発環境
- **Google Apps Script (GAS)**: サーバーレス実行環境
- **clasp**: ローカル開発・デプロイツール
- **Git/GitHub**: バージョン管理
- **Google Classroom API v1**: クラス・トピック・招待管理
- **Google Sheets API**: スプレッドシート操作

### プロジェクト構成
```
classroom-automation/
├── appsscript.json          # GASマニフェスト（OAuth scopes設定）
├── src/
│   ├── main.gs              # メインエントリーポイント
│   ├── config.gs            # 設定管理モジュール
│   ├── phases/
│   │   ├── phase1_archive.gs      # Phase 1実装
│   │   ├── phase2_create.gs       # Phase 2実装
│   │   ├── phase3_topics.gs       # Phase 3実装
│   │   └── phase4_members.gs      # Phase 4実装
│   ├── services/
│   │   ├── sheet_service.gs       # スプレッドシート操作
│   │   └── data_transformer.gs    # データ変換
│   ├── utils/
│   │   ├── logger.gs              # ログ記録
│   │   └── error_handler.gs       # エラー処理
│   └── debug/
│       └── debug_tools.gs         # デバッグ・診断ツール
└── .clasp.json              # clasp設定
```

---

## 📖 使用方法

### 前提条件
- Google Workspaceアカウント（@office.kyoto-art.ac.jp）
- GASプロジェクトへのアクセス権
- スプレッドシートへの編集権限

### 実行手順

#### 1. 初回セットアップ
1. GASエディタを開く: https://script.google.com/d/1lFH4ilIL4nczSNGaYikqvh3oQ1FO5J4moIAu367vxnhIzTKmgPxyhoSQ/edit
2. 初回実行時にOAuth認証を承認

#### 2. テスト実行（推奨）
```javascript
// システム設定シートでDRY_RUN_MODE = TRUE に設定
testPhase1()  // Phase 1のテスト
testPhase2()  // Phase 2のテスト
testPhase3()  // Phase 3のテスト
testPhase4()  // Phase 4のテスト
```

#### 3. 本番実行
```javascript
// システム設定シートでDRY_RUN_MODE = FALSE に変更
runPhase1Archive()           // Phase 1実行
runPhase2CreateClasses()     // Phase 2実行
runPhase3CreateTopics()      // Phase 3実行
runPhase4RegisterMembers()   // Phase 4実行
```

#### 4. 実行結果の確認
- スプレッドシート「登録処理ログ」シート: 全処理結果
- スプレッドシート「エラー未処理リスト」シート: エラー詳細

---

## 🔒 セキュリティ・権限

### OAuth Scopes（承認済み）
- `classroom.courses` - クラスの作成・更新・アーカイブ
- `classroom.topics` - トピックの作成・管理
- `classroom.rosters` - 生徒・教員の招待管理
- `classroom.profile.emails` - ユーザー情報の取得
- `spreadsheets` - スプレッドシートの読み書き

### データアクセス
- 実行者のアカウントで動作（スクリプト実行者がクラスのオーナーになる）
- スプレッドシートID: `1BJ-KBSQyJqbb9F8ixBWfXKLlPP4iALfsfuv9DJ-2or4`
- 外部への通信: Google Classroom API・Sheets APIのみ

---

## 🐛 トラブルシューティング

### よくある問題と解決策

| 問題 | 原因 | 解決策 |
|------|------|--------|
| DRY_RUN_MODE設定が見つからない | システム設定シートの設定不足 | A列に「DRY_RUN_MODE」、B列に「TRUE」を追加 |
| シートが見つかりません | 必須シートの欠落 | 要件定義書に従って必須シートを作成 |
| 権限不足エラー | OAuth認証未完了 | GASエディタで再認証 |
| API Rate Limit超過 | 連続リクエスト過多 | 自動リトライ機能が動作（待機後に再実行） |

### デバッグ機能
トラブル時は以下の関数で診断可能:
```javascript
checkClassOwner(courseId)    // クラスオーナー権限の確認
debugPhase4Data()            // データ変換結果の表示
diagnoseApiPermission()      // API権限の診断
```
（※ デバッグ関数は `src/debug/debug_tools.gs` に格納）

---

## 📈 今後の拡張予定

以下の機能を将来的に追加予定（詳細は `FUTURE_FEATURES.md` を参照）:

### 優先度：高
1. **招待承諾状況の確認機能** - 誰が招待を承諾したか確認
2. **招待の再送信機能** - 未承諾者への再招待

### 優先度：中
3. **メンバーの一括削除機能** - 間違って登録した場合の削除
4. **クラス設定の一括更新機能** - クラス説明文などの一括変更

---

## 📚 関連ドキュメント

| ドキュメント | 概要 |
|-------------|------|
| [README.md](./README.md) | 基本的な使い方・セットアップ手順 |
| [DEVELOPMENT.md](./DEVELOPMENT.md) | 開発ログ・技術詳細 |
| [FUTURE_FEATURES.md](./FUTURE_FEATURES.md) | 今後の開発予定機能 |
| [要件定義書](./Google_Classroom_年度更新自動化システム_要件定義書_v2.md) | 詳細な仕様・データ構造 |

---

## 🎯 結論

Google Classroom 年度更新自動化システムの基本機能（Phase 1～4）が完成し、以下を達成しました:

✅ **年度更新作業時間を94%削減**（9.2時間 → 0.5時間）
✅ **ヒューマンエラーの防止**
✅ **データ整合性の向上**
✅ **完全なログ・トレーサビリティ**

本システムは実運用可能な状態であり、年度更新作業の大幅な効率化が期待できます。

今後は運用フィードバックを基に、招待承諾状況の確認機能などの追加機能を段階的に実装予定です。

---

**本件に関するお問い合わせ**:
野中孝利 (t-nonaka@office.kyoto-art.ac.jp)
